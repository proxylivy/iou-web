# IOU WEB - Apache 2.24 Config
# HTTP/2 and PHP-FPM enabled + Hardened options

<Directory />
    Options None
    AllowOverride None
    Require all denied
</Directory>

<Directory /opt/iou/html>
    AllowOverride All
    Require all granted
</Directory>

<Directory /opt/iou/data>
    AllowOverride None
    Options +Indexes -FollowSymLinks
    IndexOptions FancyIndexing FoldersFirst SuppressIcon SuppressHTMLPreamble
    IndexIgnore .htaccess .ftpquota .DS_Store favicon.ico HEADER.html FOOTER.html icons *~ *# *,v *,t .??*
    HeaderName /includes/HEADER.html
    ReadmeName /includes/FOOTER.html
    Require all granted
    AddDescription "Exported files" Export
    AddDescription "Imported files" Import
    AddDescription "Log files" Logs
    AddDescription "PCAP/Sniffer files" Sniffer
    AddDescription "Current database file" database.sdb
    AddDescription "Initial database file" template.sdb
    AddDescription "Apache access log file" access.txt
    AddDescription "Apache error log file" error.txt
    AddDescription "IOU log file" exec.txt
    AddDescription "PHP log file" php_errors.txt
</Directory>

<Directory /opt/iou/cgi-bin/>
    AllowOverride None
    Options None
    Require all granted
    SetHandler cgi-script
</Directory>

<FilesMatch "^\.">
    Require all denied
</FilesMatch>
<FilesMatch "(^#.*#|~)$">
    Require all denied
</FilesMatch>

AddOutputFilterByType DEFLATE text/html text/plain text/xml text/javascript application/javascript text/css

ServerTokens Prod
ServerSignature Off
TraceEnable off

## Unset Header
Header always unset X-Powered-By
Header always unset X-AspNet-Version
Header always unset X-AspNetMvc-Version

## Set Header
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), fullscreen=(self)"
Header always set Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; object-src 'none'; frame-ancestors 'self'; base-uri 'self';"
Header always set X-Download-Options "noopen"
Header always set X-Permitted-Cross-Domain-Policies "none"
Header always set Cross-Origin-Resource-Policy "same-origin"
Header always set Cross-Origin-Embedder-Policy "require-corp"

# HTTP/2 Optimization
H2Direct on
H2ModernTLSOnly on
H2Upgrade on
ProtocolsHonorOrder On

<VirtualHost *:80>
    ServerAdmin webmaster@iou.example.com
    ServerName iou.example.com
    DocumentRoot /opt/iou/html
    
    RewriteEngine On
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

# HTTPS real del sitio
<VirtualHost *:443>
    ServerAdmin webmaster@iou.example.com
    ServerName iou.example.com
    DocumentRoot /opt/iou/html
    Protocols h2 http/1.1
    
    LogLevel warn ssl:error
    ErrorLog /opt/iou/data/Logs/error.txt
    CustomLog /opt/iou/data/Logs/access.txt common
    
    RewriteEngine On
    RewriteCond %{REQUEST_URI}        (\.\./|\.\.\\) [NC,OR]
    RewriteCond %{QUERY_STRING}       (\.\./|%2e%2e%2f|%5c|%255c|%2f%2e%2e|%00|%2500|%2e%2e) [NC]
    RewriteRule ^ - [F]  # 403 Forbidden
    SSLEngine on
    SSLCertificateFile /etc/pki/tls/iou/iou.crt
    SSLCertificateKeyFile /etc/pki/tls/iou/iou.key
    SSLCipherSuite PROFILE=SYSTEM
#    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLProtocol TLSv1.2 TLSv1.3
    SSLHonorCipherOrder on
    SSLCompression off
    SSLSessionTickets off
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    ScriptAlias /cgi-bin/ /opt/iou/cgi-bin/
    Alias /downloads /opt/iou/data/

    # PHP-FPM v√≠a socket Unix
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost/"
    </FilesMatch>
</VirtualHost>

<VirtualHost 127.0.0.127:80>
    ServerAdmin webmaster@xml.cisco.com
    DocumentRoot /var/www/html
    ServerName xml.cisco.com
    ErrorLog /dev/null
    CustomLog /dev/null common
</VirtualHost>
